---
- name: Include vars
  ansible.builtin.include_vars:
    file: ../../../../vars/main.yml

# wal_g_cron_jobs[0].job
- name: Setting wal_g_cron_jobs[0].job
  ansible.builtin.set_fact: # yamllint disable rule:line-length
    origin_wal_g_cron_jobs_create_job: "[ $(curl -s -o /dev/null -w '%{http_code}' http://{{ inventory_hostname }}:{{ patroni_restapi_port }}) = '200' ] && wal-g backup-push {{ postgresql_data_dir }} > {{ postgresql_log_dir }}/walg_backup.log 2>&1"

- name: Debug wal_g_cron_jobs[0].job
  debug:
    var: wal_g_cron_jobs[0].job

- name: Assert wal_g_cron_jobs[0].job
  assert:
    that:
      - wal_g_cron_jobs[0].job == origin_wal_g_cron_jobs_create_job
    fail_msg: >
      Assertion failed: wal_g_cron_jobs[0].job is "{{ wal_g_cron_jobs[0].job }}",
      but expected "{{ origin_wal_g_cron_jobs_create_job }}"
    success_msg: "wal_g_cron_jobs[0].job is correct"


# wal_g_cron_jobs[1].job
- name: Setting wal_g_cron_jobs[1].job
  ansible.builtin.set_fact: # yamllint disable rule:line-length
    origin_wal_g_cron_jobs_delete_job: "[ $(curl -s -o /dev/null -w '%{http_code}' http://{{ inventory_hostname }}:{{ patroni_restapi_port }}) = '200' ] && wal-g delete retain FULL 4 --confirm > {{ postgresql_log_dir }}/walg_delete.log 2>&1"

- name: Debug wal_g_cron_jobs[1].job
  debug:
    var: wal_g_cron_jobs[1].job

- name: Assert wal_g_cron_jobs[1].job
  assert:
    that:
      - wal_g_cron_jobs[1].job == origin_wal_g_cron_jobs_delete_job
    fail_msg: >
      Assertion failed: wal_g_cron_jobs[1].job is "{{ wal_g_cron_jobs[1].job }}",
      but expected "{{ origin_wal_g_cron_jobs_delete_job }}"
    success_msg: "wal_g_cron_jobs[1].job is correct"
