---
# 🚀 These tasks aim to test the "ansible.builtin.lineinfile" task
# 🎯 The objective is to ensure that the lines are correctly replaced

# 📂 Ensure tmp directory exists
- name: Molecule.tests.roles.confd.variables.haproxy.cfg | Ensure tmp directory exists
  ansible.builtin.file:
    path: "./tmp"
    state: directory

# 🔄 Define a dummy template file
- name: Molecule.tests.roles.confd.variables.haproxy.cfg | Set template file test data
  ansible.builtin.set_fact:
    haproxy_listen_port:
      stats: 8080
      master: 8081
      replicas: 8082
      replicas_sync: 8083
      replicas_async: 8084
    inventory_hostname: una.name

# ===========================================
# 💻 Start haproxy.cfg Operations and Tests
# ===========================================

# 📝 Establishing test data for haproxy.cluster_vip.defined.tmpl
- name: Molecule.tests.roles.confd.variables.haproxy.cfg | Establish haproxy.cfg Test Data
  ansible.builtin.copy:
    dest: "./tmp/haproxy.cluster_vip.defined.tmpl"
    content: |
      bind *:{{ haproxy_listen_port.stats }}
      bind *:{{ haproxy_listen_port.master }}
      bind *:{{ haproxy_listen_port.replicas }}
      bind *:{{ haproxy_listen_port.replicas_sync }}
      bind *:{{ haproxy_listen_port.replicas_async }}

# 🚀 Execute the main task here
# This task updates the 'haproxy.cfg' file
# replacing lines that start with 'bind' and include specific ports
# The new lines will either bind to the inventory_hostname or the cluster_vip, depending on the specific port.
- name: Molecule.tests.roles.confd.variables.haproxy.cfg | Update haproxy.cfg (replace "bind" for stats)
  ansible.builtin.lineinfile:
    path: ./tmp/haproxy.cluster_vip.defined.tmpl
    regexp: "{{ line_item.regexp }}"
    line: "{{ line_item.line }}"
    backrefs: true
  loop:
    - regexp: '^.*bind.*:{{ haproxy_listen_port.stats }}$'
      line: '    bind {{ inventory_hostname }}:{{ haproxy_listen_port.stats }}'
    - regexp: '^.*bind.*:{{ haproxy_listen_port.master }}$'
      line: '    bind {{ inventory_hostname }}:{{ haproxy_listen_port.master }}'
    - regexp: '^.*bind.*:{{ haproxy_listen_port.replicas }}$'
      line: '    bind {{ inventory_hostname }}:{{ haproxy_listen_port.replicas }}'
    - regexp: '^.*bind.*:{{ haproxy_listen_port.replicas_sync }}$'
      line: '    bind {{ inventory_hostname }}:{{ haproxy_listen_port.replicas_sync }}'
    - regexp: '^.*bind.*:{{ haproxy_listen_port.replicas_async }}$'
      line: '    bind {{ inventory_hostname }}:{{ haproxy_listen_port.replicas_async }}'
  loop_control:
    loop_var: line_item
    label: "{{ line_item.line }}"

# 🖨️ Debugging the established haproxy.cfg
- name: Molecule.tests.roles.confd.variables.haproxy.cfg | Debug haproxy.cfg
  ansible.builtin.command:
    cmd: cat ./tmp/haproxy.cluster_vip.defined.tmpl
  register: output
- name: Molecule.tests.roles.confd.variables.haproxy.cfg | Debug haproxy.cfg content
  ansible.builtin.debug:
    var: output.stdout_lines

# ✅ Verifying the correctness of the established haproxy.cfg
# If the lines are not replaced correctly, the test fails and an error message is displayed
- name: Molecule.tests.roles.confd.variables.haproxy.cfg | Validate updated haproxy.cfg
  ansible.builtin.assert:
    that:
      - "output.stdout_lines[0] == '    bind una.name:8080'"
      - "output.stdout_lines[1] == '    bind una.name:8081'"
      - "output.stdout_lines[2] == '    bind una.name:8082'"
      - "output.stdout_lines[3] == '    bind una.name:8083'"
      - "output.stdout_lines[4] == '    bind una.name:8084'"
    fail_msg: "Test failed: Lines are not replaced correctly in haproxy.cfg."
    success_msg: "Test passed: Lines are replaced correctly in haproxy.cfg."
